function startSelectImage(e){console.log("startSelectImage()");try{var l=e.target.files,t=l[0].name;console.log("fileName=",t);var o=t.substring(0,t.lastIndexOf(".")),n=t.substring(t.lastIndexOf(".")+1);filePickerImageElem.value=null,krpano.call(handleSelectImageCallbackName+"(null, "+o+", "+n+");")}catch(a){console.error(a),krpano.call(handleSelectImageCallbackName+"('"+a.message+"');")}}function startSelectVideo(e){console.log("startSelectVideo()");try{var l=e.target.files,t=l[0].name;console.log("fileName=",t);var o=t.substring(0,t.lastIndexOf(".")),n=t.substring(t.lastIndexOf(".")+1);filePickerVideoElem.value=null,getVideoInfo("videos/"+t,function(e,l,t){console.log("getVideoInfo",e,l,t),krpano.call(handleSelectVideoCallbackName+"(null, "+o+", "+n+", "+e+", "+l+", "+t+");")})}catch(a){console.error(a),krpano.call(handleSelectVideoCallbackName+"('"+a.message+"');")}}function getVideoInfo(e,l){console.log("getVideoInfo()");var t=document.createElement("video");t.autoplay=!0,t.oncanplay=function(){console.log("video.oncanplay()"),l(this.offsetWidth,this.offsetHeight,this.duration),this.src="about:blank",document.body.removeChild(t)},document.body.appendChild(t),t.src=e}function startSelectOffline(e){console.log("startSelectOffline()");try{for(var l,t=e.target.files,o=0;l=t[o];o++)filesOffline.push(l);filePickerOfflineElem.value=null,krpano.call(handleSelectOfflineCallbackName+"(null, "+filesOffline.length+");")}catch(n){console.error(n),krpano.call(handleSelectOfflineCallbackName+"('"+n.message+"');")}}function saveTextAsFile(e,l,t){console.log("saveTextAsFile()");try{var o=new Blob([e],{type:"text/xml"});if(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./))window.navigator.msSaveBlob(o,l);else{var n=document.createElement("a");n.download=l,n.innerHTML="Download File";var a=window.URL||window.webkitURL;a&&(n.href=a.createObjectURL(o),n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n)),n.click()}t()}catch(r){t(r)}}function getSettings(e){console.log("getSettings()"),parseXmlFile(fileNameSettingsXml,function(l,t){try{if(l)throw l;var o=$(t),n=o.find("robertitor_settings");e(null,n)}catch(a){return console.error(a),void e(a,null)}})}function readSupportedStyles(){console.log("readSupportedStyles()"),getSettings(function(e,l){if(e)return void console.error(e);if(l){supportedStyleNames=[];for(var t=0;t<settingsSupportedStyles.length;t++){var o=l[0].attributes[settingsSupportedStyles[t]].value;o&&supportedStyleNames.push(o)}console.log("Settings loaded. Supported styles:",supportedStyleNames)}else console.warn("No settings read.")})}$.ajaxSetup({beforeSend:function(e){e.overrideMimeType&&(e.overrideMimeType("text/plain"),e.overrideMimeType("text/xml"),e.overrideMimeType("application/json"),e.overrideMimeType("text/x-jquery-tmpl")),e.setRequestHeader("Access-Control-Allow-Origin","*")}}),$(document).ajaxError(function(){console.error("Triggered ajaxError handler.")});var krpano,filePickerImageElem,handleSelectImageCallbackName,filePickerVideoElem,handleSelectVideoCallbackName,filePickerOfflineElem,handleSelectOfflineCallbackName,filesOffline=[],fileNameTourXml="../../vtour/tour.xml",fileNameAutotourXml="autotour_definition.xml",fileNameOfflineSettingsXml="offlinerules/offline_rules_settings.xml",fileNameOfflineXml="offline_rules.xml",fileNameSettingsXml="robertitor/settings.xml",settingsSupportedStyles=["image_hotspot_style","scene_hotspot_style","video_hotspot_style"],supportedStyleNames,parseXmlFile=function(e,l){console.log("parseXmlFile("+e+")"),$.ajax({url:e,dataType:"xml",success:function(t){console.log(e+" file loaded"),l(null,t)},error:function(t,o,n){console.error(e+" file error"),l(new Error(t.responseText),null)}})},serializeXmlDoc=function(e,l){var t=(new XMLSerializer).serializeToString(e);return l&&(t=vkbeautify.xml(t,2)),t};$.createHotspotXML=function(e,l){var t=$(e[0].createElement("hotspot"));return t.attr("name",l.name),t.attr("style",l.style),t.attr("ath",l.ath),t.attr("atv",l.atv),void 0!==l.linkedscene&&t.attr("linkedscene",l.linkedscene),t};var handleSelectImage=function(e){console.log("handleSelectImage("+e+")"),handleSelectImageCallbackName=e,filePickerImageElem.click()},handleSelectVideo=function(e){console.log("handleSelectVideo("+e+")"),handleSelectVideoCallbackName=e,filePickerVideoElem.click()},handleSelectOffline=function(e){console.log("handleSelectOffline("+e+")"),handleSelectOfflineCallbackName=e,filePickerOfflineElem.click()},handleExportOffline=function(e){console.log("handleExportOffline("+e+")"),parseXmlFile(fileNameOfflineSettingsXml,function(l,t){try{if(l)throw l;var o=$(t),n=o.find("offline_rules_settings"),a=n.attr("domain_rules_path"),r=n.attr("rule_match");if(!(filesOffline.length>0)){var l=new Error("No images selected for cache rules.");throw l}var i=$($.parseXML('<?xml version="1.0" encoding="UTF-8"?><rules/>')),s=$(i.find("rules"));s.attr("domain",a);var c=$("<rule></rule>",i[0]);c.attr("match",r),s.append(c);for(var f,d=0;f=filesOffline[d];d++){console.log("f["+d+"]=",f.name,f.type);var m=$("<addResource />",i[0]);m.attr("uri",f.webkitRelativePath),m.attr("type",f.type),c.append(m)}console.log(i[0])}catch(u){return console.error(u),void krpano.call(e+"('"+u.message+"');")}saveTextAsFile(serializeXmlDoc(i[0],!0),fileNameOfflineXml,function(l){l?(console.error(l),krpano.call(e+"('"+l.message+"');")):krpano.call(e+"(null, '"+fileNameOfflineXml+"');")})})},handleSaveHotspot=function(e){console.log("handleSaveHotspot("+e+")");try{var l=krpano.get("xml").scene;console.log("active scene name:",l);var t=krpano.get("hotspot")}catch(o){return console.error(o),void krpano.call(e+"('"+o.message+"');")}parseXmlFile(fileNameTourXml,function(o,n){try{if(o)throw o;for(var a,r=$(n),i=r.find("scene").filter(function(){return $(this).attr("name").toLowerCase()==l.toLowerCase()}),s=[],c=0;c<t.count;c++){var f=t.getItem(c);console.log("k_hotspot.name=",f.name),s.push(f.name);var d=i[0].innerHTML;if(void 0===a&&d){var m=0;0==d.indexOf("\n")&&(m=1),a=d.substring(m,d.indexOf("<"));var u=a.split("	").length-1;if(u>0){a="";for(var g=0;u/2>g;g++)a+="	"}else{var p=a.split(" ").length-1;a="";for(var g=0;p/2>g;g++)a+=" "}console.log('indentStr="'+a+'"')}if($hs=i.find('hotspot[name="'+f.name+'"]'),$hs.length>0)console.log("$hs=",$hs),$hs.attr("atv",f.atv),$hs.attr("ath",f.ath),$hs.attr("style",f.style),void 0!==f.linkedscene&&$hs.attr("linkedscene",f.linkedscene);else if(console.log("no $hs"),$.inArray(f.style,supportedStyleNames)>-1){console.log("adding new hotspot:",f.name);var h=$.createHotspotXML(r,f);i.append(a),i.append(h),i.append("\n"),i.append(a)}else console.log("skipping unsupported hotspot; style:",f.style)}i.find("hotspot").each(function(){var e=$(this).attr("name");$.inArray(e,s)<0&&($(this).remove(),console.log("removed "+e+" from xml"))}),console.log(r[0])}catch(v){return console.error(v),void krpano.call(e+"('"+v.message+"');")}saveTextAsFile(serializeXmlDoc(r[0],!1),fileNameTourXml,function(l){l?(console.error(l),krpano.call(e+"('"+l.message+"');")):krpano.call(e+"(null, '"+fileNameTourXml+"');")})})},handleSaveAutotour=function(e){console.log("handleSaveAutotour("+e+")");try{var l=krpano.get("autotour_preview");console.log("autotour_preview:",l);var t=l.step;if(!(t.count>0)){var o=new Error("No steps defined for autotour.");throw o}var n=$($.parseXML('<?xml version="1.0" encoding="UTF-8"?><krpano/>')),a=$(n.find("krpano")),r=$("<autotour_definition></autotour_definition>",a[0]);a.append(r);for(var i=0;i<t.count;i++){var s=t.getItem(i);console.log("k_autotour_step ["+i+"]=",s.name,s.action);var c=$("<step />",a[0]);c.attr("name",s.name),c.attr("action",s.action),r.append(c)}console.log(a[0])}catch(f){return console.error(f),void krpano.call(e+"('"+f.message+"');")}saveTextAsFile(serializeXmlDoc(a[0],!0),fileNameAutotourXml,function(l){l?(console.error(l),krpano.call(e+"('"+l.message+"');")):krpano.call(e+"(null, '"+fileNameAutotourXml+"');")})},destroyClickedElement=function(e){document.body.removeChild(e.target)};$(document).ready(function(){console.log("document.ready"),krpano=document.getElementById("krpanoSWFObject"),filePickerImageElem=document.getElementById("filePickerImage"),filePickerImageElem&&filePickerImageElem.addEventListener("change",startSelectImage,!1),filePickerVideoElem=document.getElementById("filePickerVideo"),filePickerVideoElem&&filePickerVideoElem.addEventListener("change",startSelectVideo,!1),filePickerOfflineElem=document.getElementById("filePickerOffline"),filePickerOfflineElem&&filePickerOfflineElem.addEventListener("change",startSelectOffline,!1),readSupportedStyles()});
